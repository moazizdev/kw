<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Electricity Usage Summary</title>
  <style>
    body {
      background: black;
      color: #00ff00;
      font-family: monospace;
      padding: 20px;
      white-space: pre-wrap;
    }

    table {
      width: 100%;
      margin-top: 20px;
      border: 1px solid #00ff00;
      border-collapse: collapse;
    }

    th, td {
      padding: 8px;
      text-align: center;
      border: 1px solid #00ff00;
    }
  </style>
</head>
<body>
  <div id="terminal">> Loading electricity usage data...</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTJUb4YPJoURYx0PodrANsKqu42k61PsGV2F4KsqMNWKAkKHwuszAGHyFH92d0WIu3LKt6rtb7jsKV-/pub?output=csv";
    const now = new Date();

    // Function to detect if the request is from curl (no user agent or terminal)
    function isCurlRequest() {
      return !navigator.userAgent || navigator.userAgent.includes('curl');
    }

    function calculateCost(kWh) {
        let cost = 0;
        let tiers = [
            { from: 0, to: 50, price: 68 },
            { from: 51, to: 100, price: 78 },
            { from: 101, to: 200, price: 95 },
            { from: 201, to: 350, price: 155 },
            { from: 351, to: 650, price: 195 },
            { from: 651, to: 1000, price: 210 }
        ];

        for (const tier of tiers) {
            if (kWh <= 0) break;

            const rangeStart = tier.from;
            const rangeEnd = tier.to;
            const unitsInTier = Math.min(kWh, rangeEnd - rangeStart + 1);

            if (unitsInTier > 0) {
            cost += unitsInTier * tier.price;
            kWh -= unitsInTier;
            }
        }

        return cost * 0.01; // Convert cents to EGP
    }

    function getCategory(kWh) {
      if (kWh <= 50) return "ÿßŸÑÿ¥ÿ±Ÿäÿ≠ÿ© ÿßŸÑÿ£ŸàŸÑŸä";
      if (kWh <= 100) return "ÿßŸÑÿ¥ÿ±Ÿäÿ≠ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©";
      if (kWh <= 200) return "ÿßŸÑÿ¥ÿ±Ÿäÿ≠ÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ©";
      if (kWh <= 350) return "ÿßŸÑÿ¥ÿ±Ÿäÿ≠ÿ© ÿßŸÑÿ±ÿßÿ®ÿπÿ©";
      if (kWh <= 650) return "ÿßŸÑÿ¥ÿ±Ÿäÿ≠ÿ© ÿßŸÑÿÆÿßŸÖÿ≥ÿ©";
      if (kWh <= 1000) return "ÿßŸÑÿ¥ÿ±Ÿäÿ≠ÿ© ÿßŸÑÿ≥ÿßÿØÿ≥ÿ©";
      return "ÿßŸÑÿ¥ÿ±Ÿäÿ≠ÿ© ÿßŸÑÿ≥ÿßÿ®ÿπÿ©";
    }

    function log(line) {
      document.getElementById("terminal").textContent += "\n" + line;
    }

    function displayAveragePerDay(data) {
        let tableHtml = "<table><thead><tr><th>#</th><th>Date & Time</th><th>Reading</th><th>Time Diff (hrs)</th><th>Avg. per Day (kWh)</th></tr></thead><tbody>";
        let terminalOutput = "> Average Usage Per Day\n---------------------------\n"; // Terminal-style output
        for (let i = data.length - 11; i < data.length - 1; i++) {
            const row = data[i];
            const nextRow = data[i + 1];

            if (nextRow) {
                const hoursDiff = (nextRow.timestamp - row.timestamp) / (1000 * 60 * 60); // in hours
                const daysDiff = hoursDiff / 24;
                const kWhUsage = nextRow.reading - row.reading;
                const avgPerDay = kWhUsage / daysDiff;

                if (isCurlRequest()) {
                    // Append terminal-style output when curl is detected
                    terminalOutput += `#${i + 1} Date: ${row.timestamp.toLocaleString('en-US')} Reading: ${row.reading} Avg. per Day: ${avgPerDay.toFixed(2)} kWh\n`;
                } else {
                    // HTML table output for browsers
                    tableHtml += `<tr>
                        <td>${i + 1}</td>
                        <td>${row.timestamp.toLocaleString('en-US')}</td>
                        <td>${row.reading}</td>
                        <td>${hoursDiff.toFixed(1)}</td>
                        <td>${avgPerDay.toFixed(2)}</td>
                    </tr>`;
                }
            }
        }

        if (isCurlRequest()) {
            log(terminalOutput);  // Show terminal-like output if curl is used
        } else {
            tableHtml += "</tbody></table>";
            document.getElementById("terminal").innerHTML += tableHtml;  // Show table in browser
        }
    }


    fetch(csvUrl)
      .then(response => response.text())
      .then(csvText => {
        const parsed = Papa.parse(csvText, { header: true });
        const data = parsed.data
          .filter(row => row["date time"]?.trim() && row["reading"]?.trim())
          .map(row => ({
            timestamp: new Date(row["date time"].trim()),
            reading: parseInt(row["reading"].trim())
          }))
          .sort((a, b) => a.timestamp - b.timestamp);

        // Filter for last month's data
        const last30Days = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        const last30DaysData = data.filter(row => row.timestamp >= last30Days);

        if (last30DaysData.length < 2) {
          log("> Not enough data for last month.");
          return;
        }

        const first = last30DaysData[0];
        const last = last30DaysData[last30DaysData.length - 1];

        const totalUsage = last.reading - first.reading;
        if (totalUsage <= 0) {
          log("> Invalid total usage data.");
          return;
        }

        const timeDiff = (last.timestamp - first.timestamp) / (1000 * 60 * 60); // time difference in hours
        const daysDiff = timeDiff / 24; // convert hours to days
        const avgPerDay = totalUsage / daysDiff;
        const cost = calculateCost(totalUsage);
        const category = getCategory(totalUsage);

        log("> Electricity Usage Summary for Last Month");
        log("----------------------------------------");
        log(`üìÖ First Reading: ${first.timestamp.toLocaleDateString()}`);
        log(`üìÖ Last Reading:  ${last.timestamp.toLocaleDateString()}`);
        log(`‚ö° Total Usage: ${totalUsage} kWh`);
        log(`üìä Average per day: ${avgPerDay.toFixed(2)} kWh/day`);
        log(`üí∞ Estimated Cost: ${cost.toFixed(2)} EGP`);
        log(`üìà Billing Category: ${category}`);

        displayAveragePerDay(data);
      })
      .catch(error => log("> ‚ùå Failed to fetch or process CSV: " + error.message));
  </script>
</body>
</html>
