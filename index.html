<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ملخص استهلاك الكهرباء / Electricity Usage Summary</title>
  <style>
    body {
      background: black;
      color: #00ff00;
      font-family: monospace;
      padding: 20px;
      white-space: pre-wrap;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border: 1px solid #00ff00;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #00ff00;
    }
    .lang-ar {
      direction: rtl;
      text-align: right;
      display: block;
    }
    .lang-en {
      direction: ltr;
      text-align: left;
      display: none;
    }
    #lang-switch {
      margin-bottom: 20px;
      color: #00ff00;
      background: transparent;
      border: 1px solid #00ff00;
      padding: 5px 10px;
      cursor: pointer;
      font-family: monospace;
    }
  </style>
</head>
<body>

<button id="lang-switch">Switch to English / التبديل إلى الإنجليزية</button>

<div id="content-ar" class="lang-ar">
  <div id="terminal-ar">&gt; جاري تحميل بيانات استهلاك الكهرباء...</div>
  <canvas id="costChartAr" width="400" height="200" style="margin-top: 30px;"></canvas>
</div>

<div id="content-en" class="lang-en">
  <div id="terminal-en">&gt; Loading electricity usage data...</div>
  <canvas id="costChartEn" width="400" height="200" style="margin-top: 30px;"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTJUb4YPJoURYx0PodrANsKqu42k61PsGV2F4KsqMNWKAkKHwuszAGHyFH92d0WIu3LKt6rtb7jsKV-/pub?output=csv";

  function isCurlRequest() {
    return !navigator.userAgent || navigator.userAgent.includes('curl');
  }

  function calculateCost(kWh) {
    let cost = 0;
    let tiers = [
      { from: 0, to: 50, price: 68 },
      { from: 51, to: 100, price: 78 },
      { from: 101, to: 200, price: 95 },
      { from: 201, to: 350, price: 155 },
      { from: 351, to: 650, price: 195 },
      { from: 651, to: 1000, price: 210 }
    ];
    for (const tier of tiers) {
      if (kWh <= 0) break;
      const rangeStart = tier.from;
      const rangeEnd = tier.to;
      const unitsInTier = Math.min(kWh, rangeEnd - rangeStart + 1);
      if (unitsInTier > 0) {
        cost += unitsInTier * tier.price;
        kWh -= unitsInTier;
      }
    }
    return cost * 0.01; // from cents to EGP
  }

  function getCategoryAr(kWh) {
    if (kWh <= 50) return "الشريحة الأولى";
    if (kWh <= 100) return "الشريحة الثانية";
    if (kWh <= 200) return "الشريحة الثالثة";
    if (kWh <= 350) return "الشريحة الرابعة";
    if (kWh <= 650) return "الشريحة الخامسة";
    if (kWh <= 1000) return "الشريحة السادسة";
    return "الشريحة السابعة";
  }

  function getCategoryEn(kWh) {
    if (kWh <= 50) return "Tier 1";
    if (kWh <= 100) return "Tier 2";
    if (kWh <= 200) return "Tier 3";
    if (kWh <= 350) return "Tier 4";
    if (kWh <= 650) return "Tier 5";
    if (kWh <= 1000) return "Tier 6";
    return "Tier 7";
  }

  function logAr(line) {
    document.getElementById("terminal-ar").textContent += "\n" + line;
  }

  function logEn(line) {
    document.getElementById("terminal-en").textContent += "\n" + line;
  }

  function displayAveragePerDay(data, isArabic = true) {
    let tableHtml = isArabic
      ? "<table><thead><tr><th>#</th><th>التاريخ والوقت</th><th>القراءة</th><th>الفارق الزمني (ساعات)</th><th>المعدل اليومي (كيلوواط/ساعة)</th></tr></thead><tbody>"
      : "<table><thead><tr><th>#</th><th>Date & Time</th><th>Reading</th><th>Time Diff (hrs)</th><th>Avg. per Day (kWh)</th></tr></thead><tbody>";

    let terminalOutput = isArabic
      ? "> متوسط الاستهلاك اليومي\n---------------------------\n"
      : "> Average Usage Per Day\n---------------------------\n";

    for (let i = data.length - 21; i < data.length - 1; i++) {
      const row = data[i];
      const nextRow = data[i + 1];
      if (!row || !nextRow) continue;

      const hoursDiff = (nextRow.timestamp - row.timestamp) / (1000 * 60 * 60);
      const daysDiff = hoursDiff / 24;
      if (daysDiff === 0) continue;

      const kWhUsage = nextRow.reading - row.reading;
      const avgPerDay = kWhUsage / daysDiff;

      if (isCurlRequest()) {
        terminalOutput += isArabic
          ? `#${i + 1} التاريخ: ${row.timestamp.toLocaleString('ar-EG')} القراءة: ${row.reading} المعدل اليومي: ${avgPerDay.toFixed(2)} كيلوواط\n`
          : `#${i + 1} Date: ${row.timestamp.toLocaleString('en-US')} Reading: ${row.reading} Avg. per Day: ${avgPerDay.toFixed(2)} kWh\n`;
      } else {
        tableHtml += `<tr>
          <td>${i + 1}</td>
          <td>${row.timestamp.toLocaleString(isArabic ? 'ar-EG' : 'en-US')}</td>
          <td>${row.reading}</td>
          <td>${hoursDiff.toFixed(1)}</td>
          <td>${avgPerDay.toFixed(2)}</td>
        </tr>`;
      }
    }

    if (isCurlRequest()) {
      if (isArabic) logAr(terminalOutput);
      else logEn(terminalOutput);
    } else {
      tableHtml += "</tbody></table>";
      if (isArabic) document.getElementById("terminal-ar").innerHTML += tableHtml;
      else document.getElementById("terminal-en").innerHTML += tableHtml;
    }
  }

  function processData(data, isArabic = true) {
    const now = new Date();
    const last30Days = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    const last30DaysData = data.filter(row => row.timestamp >= last30Days);

    if (last30DaysData.length < 2) {
      if (isArabic) logAr("> لا توجد بيانات كافية للشهر الماضي.");
      else logEn("> Not enough data for last month.");
      return;
    }

    const first = last30DaysData[0];
    const last = last30DaysData[last30DaysData.length - 1];
    const totalUsage = last.reading - first.reading;

    if (totalUsage <= 0) {
      if (isArabic) logAr("> بيانات الاستهلاك غير صالحة.");
      else logEn("> Invalid total usage data.");
      return;
    }

    const timeDiff = (last.timestamp - first.timestamp) / (1000 * 60 * 60);
    const daysDiff = timeDiff / 24;
    const avgPerDay = totalUsage / daysDiff;
    const cost = calculateCost(totalUsage);
    const category = isArabic ? getCategoryAr(totalUsage) : getCategoryEn(totalUsage);

    if (isCurlRequest()) {
      if (isArabic) {
        logAr(`\nملخص استهلاك الكهرباء في آخر 30 يومًا:\n- إجمالي الاستهلاك: ${totalUsage.toFixed(2)} كيلوواط\n- المعدل اليومي: ${avgPerDay.toFixed(2)} كيلوواط\n- التكلفة المقدرة: ${cost.toFixed(2)} جنيه مصري\n- الشريحة: ${category}`);
      } else {
        logEn(`\nElectricity Usage Summary for Last 30 Days:\n- Total Usage: ${totalUsage.toFixed(2)} kWh\n- Average per Day: ${avgPerDay.toFixed(2)} kWh\n- Estimated Cost: ${cost.toFixed(2)} EGP\n- Tier: ${category}`);
      }
    } else {
      const contentEl = isArabic ? document.getElementById("terminal-ar") : document.getElementById("terminal-en");
      contentEl.textContent += `\n\n${isArabic ? 'ملخص استهلاك الكهرباء في آخر 30 يومًا:' : 'Electricity Usage Summary for Last 30 Days:'}\n`;
      contentEl.textContent += `- ${isArabic ? 'إجمالي الاستهلاك' : 'Total Usage'}: ${totalUsage.toFixed(2)} ${isArabic ? 'كيلوواط' : 'kWh'}\n`;
      contentEl.textContent += `- ${isArabic ? 'المعدل اليومي' : 'Average per Day'}: ${avgPerDay.toFixed(2)} ${isArabic ? 'كيلوواط' : 'kWh'}\n`;
      contentEl.textContent += `- ${isArabic ? 'التكلفة المقدرة' : 'Estimated Cost'}: ${cost.toFixed(2)} ${isArabic ? 'جنيه مصري' : 'EGP'}\n`;
      contentEl.textContent += `- ${isArabic ? 'الشريحة' : 'Tier'}: ${category}\n`;
    }

    displayAveragePerDay(data, isArabic);

    // Chart plotting
    if (!isCurlRequest()) {
      const ctx = isArabic ? document.getElementById('costChartAr').getContext('2d') : document.getElementById('costChartEn').getContext('2d');

      const labels = [];
      const costs = [];
      const rollingCosts = [];

      for (let i = 1; i < data.length; i++) {
        const prev = data[i - 1];
        const curr = data[i];
        const usage = curr.reading - prev.reading;
        const costValue = calculateCost(usage);

        labels.push(curr.timestamp.toLocaleDateString(isArabic ? 'ar-EG' : 'en-US'));
        costs.push(costValue);

        if (rollingCosts.length === 0) {
          rollingCosts.push(costValue);
        } else {
          rollingCosts.push((costValue + rollingCosts[rollingCosts.length - 1]) / 2);
        }
      }

      // Remove old chart if exists
      if (window.myChart) window.myChart.destroy();

      window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: isArabic ? 'تكلفة الاستهلاك' : 'Cost',
              data: costs,
              borderColor: '#00ff00',
              backgroundColor: 'transparent',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 0,
              fill: false,
            },
            {
              label: isArabic ? 'متوسط متحرك للتكلفة' : 'Rolling Average Cost',
              data: rollingCosts,
              borderColor: '#006600',
              backgroundColor: 'transparent',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 0,
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#00ff00' } },
          },
          scales: {
            x: { ticks: { color: '#00ff00' } },
            y: {
              ticks: {
                color: '#00ff00',
                callback: value => value.toFixed(2) + ' EGP',
              },
            },
          },
        },
      });
    }
  }

  function parseCSVAndProcess(csvText) {
    const parsed = Papa.parse(csvText.trim(), {
      header: false,
      skipEmptyLines: true,
    });

    if (parsed.errors.length > 0) {
      console.error('CSV parsing errors:', parsed.errors);
      alert('خطأ في تحليل بيانات CSV');
      return;
    }

    // تحويل البيانات إلى مصفوفة من الكائنات مع timestamp و reading
    const data = parsed.data
      .map(row => {
        // نفترض أن التاريخ في العمود 0 والقراءة في العمود 1
        const dateStr = row[0];
        const readingStr = row[1];
        const timestamp = new Date(dateStr);
        const reading = parseFloat(readingStr);
        if (isNaN(timestamp.getTime()) || isNaN(reading)) return null;
        return { timestamp, reading };
      })
      .filter(x => x !== null)
      .sort((a, b) => a.timestamp - b.timestamp);

    if (data.length === 0) {
      alert('لا توجد بيانات صالحة في ملف CSV');
      return;
    }

    processData(data, true);  // اللغة العربية
    processData(data, false); // اللغة الإنجليزية
  }

  fetch(csvUrl)
    .then(res => res.text())
    .then(text => {
      if (!text) throw new Error("Empty CSV");
      parseCSVAndProcess(text);
    })
    .catch(err => {
      console.error("Failed to load or parse CSV:", err);
      document.getElementById("terminal-ar").textContent = "> فشل تحميل البيانات.";
      document.getElementById("terminal-en").textContent = "> Failed to load data.";
    });

  // تبديل اللغة
  document.getElementById("lang-switch").addEventListener("click", () => {
    const arDiv = document.getElementById("content-ar");
    const enDiv = document.getElementById("content-en");
    if (arDiv.style.display === "none") {
      arDiv.style.display = "block";
      enDiv.style.display = "none";
      document.getElementById("lang-switch").textContent = "Switch to English / التبديل إلى الإنجليزية";
    } else {
      arDiv.style.display = "none";
      enDiv.style.display = "block";
      document.getElementById("lang-switch").textContent = "التبديل إلى العربية / Switch to Arabic";
    }
  });
</script>

</body>
</html>
